apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: snow-test-open
spec:
  serviceAccountName: promotion-template # pcf-default-promotion-workflows-sa
  arguments:
    parameters:
    - name: PRODUCT_NAME
    # - name: RELEASE_ID
    # - name: PROMOTION_FLOW_NAME
    # - name: RELEASE_URL
    # - name: COMMIT_SHA
    # - name: VERSION
  entrypoint: sn-open-cr-std-hook
  templates:
  - name: sn-open-cr-std-hook
    outputs:
      parameters:
      - name: CR_SYSID
        valueFrom:
          expression: "tasks['create-sn-cr'].outputs.parameters['CR_SYSID']"

    dag:
      tasks:
        - name: create-sn-cr
          templateRef:
            name: argo-hub.servicenow.1.4.0
            template: createcr
          arguments:
            parameters:
            - name: SN_IMAGE_NAME
              value: 'docker.io/lrochette/argo-hub-servicenow-integration'
            - name: SN_IMAGE_TAG
              value: "1.4.0"
            - name: TOKEN
              value: cf-api-key-aperture
            - name: CF_RUNTIME
              value: demo
            - name: SN_INSTANCE
              value: "https://dev240253.service-now.com/"
            - name: SN_AUTH
              value: "sn-auth"
            - name: LOG_LEVEL
              value: "info"
            - name: STD_CR_TEMPLATE
              value: "Reboot Windows Server"
            - name: CR_DATA
              value: >-
                {"short_description": "Product {{ workflow.parameters.PRODUCT_NAME }} deployment with pre-approved template",
                 "justification": "My app is awesome! Please deploy ASAP",
                 "assignment_group": "679434f053231300e321ddeeff7b12d8"
                }
