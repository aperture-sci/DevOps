version: "1.0"

steps:
  clone:
    title: "Cloning repository for Environment"
    type: git-clone
    git: github
    repo: aperture-sci/DevOps
    revision: main
    depth: 1
    exclude_blobs: true

  create_branch:
    title: "Create temp branch"
    image: maniator/gh
    working_directory: ${{clone}}
    commands:
      - |
        export BRANCH="${ENV}-temp-$(date +%s)"
        cf_export BRANCH=$BRANCH
        git checkout -b $BRANCH

  update_manifest:
    description: update the image version for the Environment
    image: codefresh/cli
    working_directory: ${{clone}}
    commands:
      - yq -i -y '.images[0].newTag="${TAG}"' manifests/color/$ENV/kustomization.yaml

  create_pr:
    title: "Create ENV PR"
    image: maniator/gh  # lrochette/ghssh:0.0.4
    working_directory: ${{clone}}
    commands:
      # - |-
      #   echo "Setup ssh"
      #   mkdir -p ~/.ssh
      #   echo "${SSH_KEY}" | tr ',' '\n' > ~/.ssh/id_ed25519
      #   touch ~/.ssh/known_hosts
      #   chmod 0600 ~/.ssh/*
      #   chmod 0700 ~/.ssh
      #   ssh-keygen -R github.com
      #   ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2> >(grep -v '^#' >&2)
      - |-
        echo "Setup git"
        git config --global user.email "laurent.rochette@octopus.com"
        git config --global user.name "Laurent Rochette"
        git add manifests/color/$ENV/kustomization.yaml
        git commit -m "Update image to deploy ${TAG}"
        git push -u origin "$BRANCH"
      - echo "Create PR"
      - |
        gh pr create -B main -H "$BRANCH" \
          -t "Automated PR to push Dev tag ${TAG}" \
          -b "This PR updates the content of the file as part of an automated workflow."
      - echo "merge PR"
      - gh pr merge "$BRANCH" --merge --delete-branch
